<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fish Purchase Billing – Advanced</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;padding:15px;background:#f4f6f8}
h2,h3{text-align:center}
input,select,button{padding:10px;margin:6px 0;width:100%;font-size:18px}
button{background:#0a7cff;color:#fff;border:none;border-radius:6px}
button.secondary{background:#555}
table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;font-size:16px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#eee}
.total{font-weight:bold;font-size:18px;margin-top:8px;text-align:right}
.section{background:#fff;padding:12px;margin-top:15px;border-radius:8px}
.actions button{padding:4px 8px;margin:2px;font-size:14px}
@media print{
  button,.section:not(.print){display:none}
  body{background:#fff}
}
</style>
</head>
<body>

<h2>Fish Purchase Billing</h2>

<div class="section print">
<input id="shop" list="shopList" placeholder="Shop Name" />
<datalist id="shopList"></datalist>

<input id="purchaser" list="purchaserList" placeholder="Purchaser Name" />
<datalist id="purchaserList"></datalist>

<input id="date" type="date" />
<div><b>Bill No:</b> <span id="billNo"></span></div>
</div>

<div class="section">
<h3>Add Fish Item</h3>
<select id="fish"></select>
<input id="newFish" placeholder="Add New Fish (Malayalam)" />
<button id="addFishBtn" class="secondary">Add Fish</button>
<input id="weight" placeholder="Weight (Kg)" type="number" />
<input id="purchase" placeholder="Purchase Price per Kg" type="number" />
<button id="addItemBtn">Add Item</button>
</div>

<table class="print">
<thead><tr><th>Item</th><th>Weight</th><th>Price</th><th>Total</th><th>Cost / Kg</th><th>Actions</th></tr></thead>
<tbody id="list"></tbody>
</table>

<div class="section">
<h3>Additional Expense</h3>
<input id="expenseAmount" placeholder="Expense Amount" type="number" />
<button id="addExpenseBtn" class="secondary">Add Expense</button>
</div>

<div class="print">
<div class="total">Items Total: ₹ <span id="itemsTotal">0</span></div>
<div class="total">Expense: ₹ <span id="expenseTotal">0</span></div>
<div class="total"><b>Grand Total: ₹ <span id="grand">0</span></b></div>
</div>

<button id="saveBillBtn">Save Bill & PDF</button>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const bills = JSON.parse(localStorage.getItem('bills')) || [];
  let billCounter = parseInt(localStorage.getItem('billCounter') || '1');
  const shops = JSON.parse(localStorage.getItem('shops')) || [];
  const purchasers = JSON.parse(localStorage.getItem('purchasers')) || [];
  const fishList = JSON.parse(localStorage.getItem('fishList')) || [];

  const shopInput = document.getElementById('shop');
  const purchaserInput = document.getElementById('purchaser');
  const dateInput = document.getElementById('date');
  const fishInput = document.getElementById('fish');
  const weightInput = document.getElementById('weight');
  const purchaseInput = document.getElementById('purchase');
  const list = document.getElementById('list');
  const billNoSpan = document.getElementById('billNo');
  const itemsTotalSpan = document.getElementById('itemsTotal');
  const expenseTotalSpan = document.getElementById('expenseTotal');
  const grandSpan = document.getElementById('grand');

  document.getElementById('shopList').innerHTML = shops.map(s=>`<option value="${s}">`).join('');
  document.getElementById('purchaserList').innerHTML = purchasers.map(p=>`<option value="${p}">`).join('');

  function renderFish(){
    fishInput.innerHTML = '<option value="">Select Fish</option>' + fishList.map(f=>`<option>${f}</option>`).join('');
  }
  renderFish();

  const today = new Date().toISOString().split('T')[0];
  dateInput.value = today;
  billNoSpan.innerText = billCounter;

  let additionalExpense = 0;

  function calc(){
    let itemsSum = 0;
    document.querySelectorAll('#list tr').forEach(r=>{
      itemsSum += parseFloat(r.querySelector('.itemTotal').innerText.replace('₹','')) || 0;
    });
    itemsTotalSpan.innerText = itemsSum.toFixed(2);
    expenseTotalSpan.innerText = additionalExpense.toFixed(2);

    document.querySelectorAll('#list tr').forEach(r=>{
      const w = parseFloat(r.children[1].innerText)||0;
      const itemTotal = parseFloat(r.querySelector('.itemTotal').innerText.replace('₹',''))||0;
      let cost = 0;
      if(w>0 && itemsSum>0){
        const itemExpense = itemTotal * (additionalExpense / itemsSum);
        cost = (itemTotal + itemExpense) / w;
      }
      r.querySelector('.itemCost').innerText = cost.toFixed(2);
    });

    grandSpan.innerText = (itemsSum + additionalExpense).toFixed(2);
  }

  function addItemRow(fish, w, p){
    const t = w * p;
    const row = document.createElement('tr');
    row.innerHTML = `<td contenteditable>${fish}</td><td contenteditable>${w}</td><td contenteditable>${p}</td><td class="itemTotal">₹ ${t.toFixed(2)}</td><td class="itemCost">0</td><td class="actions"><button class="editBtn">Update</button><button class="delBtn">Delete</button></td>`;
    list.appendChild(row);

    row.querySelector('.editBtn').onclick = ()=>{
      const w2 = parseFloat(row.children[1].innerText)||0;
      const p2 = parseFloat(row.children[2].innerText)||0;
      row.querySelector('.itemTotal').innerText = '₹ ' + (w2*p2).toFixed(2);
      calc();
    };
    row.querySelector('.delBtn').onclick = ()=>{row.remove(); calc();};
    calc();
  }

  document.getElementById('addFishBtn').onclick = ()=>{
    const nf = document.getElementById('newFish').value.trim();
    if(!nf) return;
    if(!fishList.includes(nf)){
      fishList.push(nf);
      localStorage.setItem('fishList', JSON.stringify(fishList));
      renderFish();
    }
    document.getElementById('newFish').value='';
  };

  document.getElementById('addItemBtn').onclick = ()=>{
    const fish = fishInput.value;
    if(!fish) return alert('Select fish');
    const w = parseFloat(weightInput.value)||0;
    const p = parseFloat(purchaseInput.value)||0;
    addItemRow(fish, w, p);
    fishInput.value=''; weightInput.value=''; purchaseInput.value='';
  };

  document.getElementById('addExpenseBtn').onclick = ()=>{
    additionalExpense = parseFloat(document.getElementById('expenseAmount').value)||0;
    calc();
  };

  document.getElementById('saveBillBtn').onclick = ()=>{
    bills.push({billNo:billCounter, shop:shopInput.value, purchaser:purchaserInput.value, date:dateInput.value, total:parseFloat(grandSpan.innerText)});
    localStorage.setItem('bills', JSON.stringify(bills));
    if(shopInput.value && !shops.includes(shopInput.value)){
      shops.push(shopInput.value); localStorage.setItem('shops', JSON.stringify(shops));
    }
    if(purchaserInput.value && !purchasers.includes(purchaserInput.value)){
      purchasers.push(purchaserInput.value); localStorage.setItem('purchasers', JSON.stringify(purchasers));
    }
    billCounter++; localStorage.setItem('billCounter', billCounter);
    window.print();
  };
});
</script>
</body>
</html>
